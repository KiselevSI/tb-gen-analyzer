# tb-gen-analyzer


Ниже приведён полный пример файла `README.md` для вашего репозитория на GitHub с подробными инструкциями по установке, настройке и использованию пайплайна:

---

```markdown
# TB Drug Resistance Pipeline

Этот репозиторий содержит Snakemake‑пайплайн для анализа VCF‑файлов (сжатых в формате `.vcf.gz`) с целью определения генетических вариантов, связанных с лекарственной устойчивостью туберкулёза. Пайплайн включает следующие этапы:

1. **Переименование хромосом.**  
   Используется `bcftools annotate` вместе с файлом `chr.txt` для переименования хромосом в исходных VCF‑файлах.

2. **Аннотация вариантов.**  
   С помощью snpEff выполняется аннотация переименованных VCF‑файлов. Вывод аннотированных вариантов сжимается через `bgzip`.

3. **Анализ устойчивости TB.**  
   Скрипт `tb_resistance.py` анализирует аннотированные VCF‑файлы и генерирует отчёт о наличии вариантов, связанных с устойчивостью, в формате CSV (а при необходимости — дополнительный подробный отчёт в формате TXT).

## Структура репозитория

```
.
├── README.md                    # Текущий файл с инструкциями по установке и использованию
├── Snakefile                    # Файл описания пайплайна для Snakemake
├── run_pipeline.py              # Скрипт для запуска пайплайна с заданными параметрами
├── scripts
│   ├── tb_resistance.py         # Скрипт для анализа аннотированного VCF и генерации отчёта по устойчивости
│   └── chr.txt                  # Файл сопоставления хромосом, используемый для переименования с bcftools
└── db
    ├── tbdb.dr.json             # База данных мутаций, связанных с устойчивостью
    ├── tbdb.bed                 # Файл сопоставления генов и препаратов
    └── tbdb.rules.yml           # (Опционально) Правила эпистаза для модификации предсказаний устойчивости
```

## Установка

Для управления окружениями используется [micromamba](https://mamba.readthedocs.io/en/latest/micromamba.html). Рекомендуется создать окружения в текущей папке с помощью опции `--prefix`.

### Создание окружений

В корневой директории репозитория выполните следующую команду, чтобы создать необходимые окружения:

```bash
micromamba create --prefix ./env -c conda-forge snakemake bcftools snpeff micromamba python=3.12
```

Эта команда создаст каталог `env` с окружением, содержащим все необходимые инструменты:  
- **snakemake** — для управления пайплайном;  
- **bcftools** — для переименования хромосом;  
- **snpEff** — для аннотации вариантов;  
- **micromamba** — для управления окружением;  
- **python 3.12** — требуемая версия Python.

### Использование окружений

В данном проекте **не требуется явная активация окружения**. Все необходимые команды запускаются через `micromamba run`, причем для каждой программы используется своё окружение, хранящееся в каталоге `env`.  
Например, запуск Snakemake осуществляется командой:

```bash
micromamba run -p env/snakemake snakemake --snakefile Snakefile --config input=... output=... -j 10
```

А вызов snpEff в Snakefile прописан следующим образом:

```bash
micromamba run -p env/snpEff snpEff ann -v {params.genome} {input.vcf} | bgzip -c > {output.annotated}
```

Таким образом, настройка и использование окружений интегрировано в механизмы запуска, и активация через `micromamba activate` не требуется.

## Использование пайплайна

### Подготовка входных данных

- Входные файлы должны быть в формате **VCF.gz**.  
- Убедитесь, что файлы располагаются в нужной директории (например, в папке `vcf`).

### Запуск пайплайна

Для запуска всего пайплайна воспользуйтесь скриптом `run_pipeline.py`. Пример вызова:

```bash
./run_pipeline.py -i vcf/*.gz -o results -t 10
```

Параметры:
- **-i** – список путей до входных VCF файлов (можно использовать glob-выражения, например, `vcf/*.gz`);
- **-o** – каталог для сохранения всех результатов (например, `results`);
- **-t** – число потоков для параллельного выполнения (например, `10`);
- **-d** (опционально) – флаг для создания дополнительного подробного отчёта (TXT). При использовании этого флага имя файла с подробностями будет формироваться заменой расширения `.csv` на `.detailed.txt`.

### Пример работы пайплайна

После запуска скрипта:
1. Пайплайн создаст необходимые каталоги (например, `results/vcf_renamed`, `results/annotated_vcfs`, `results/dr`).
2. Будут выполнены последовательно все этапы: переименование VCF‑файлов, их аннотация с помощью snpEff и анализ устойчивости с помощью `tb_resistance.py`.
3. Итоговые отчёты (в формате CSV, а при флаге `-d` и подробный TXT‑отчёт) появятся в подкаталоге `results/dr/<sample>/`.

## Дополнительные Примечания

- **Предупреждения snpEff:**  
  Во время аннотации вы можете увидеть предупреждения, такие как `WARNING_TRANSCRIPT_NO_START_CODON`. Эти сообщения информативны и обусловлены особенностями аннотируемого генома. Они не останавливают выполнение пайплайна.

- **Сообщения libmamba:**  
  При запуске через `micromamba run` могут появляться временные сообщения о блокировках (например, `Could not set lock (Resource temporarily unavailable)`). Эти предупреждения вызваны конкуренцией за общий кэш и не влияют на корректность выполнения пайплайна.

- **Логи Snakemake:**  
  Логи выполнения хранятся в каталоге `.snakemake/log/`. Если обнаруживаются ошибки или отсутствуют ожидаемые выходные файлы, просмотрите логи для получения дополнительной информации.

## Вклад и Поддержка

Если вы обнаружите ошибки, предложите улучшения или у вас возникнут вопросы по использованию пайплайна, пожалуйста, создайте [issue](https://github.com/your_username/your_repo/issues) или отправьте pull request.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности смотрите в файле [LICENSE](LICENSE).

---

*Обновлено: 09.04.2025*
```

---

Этот файл README.md содержит подробное описание по установке (с использованием micromamba с префиксом), объяснение работы с окружениями (без необходимости их активации) и подробные инструкции по использованию и запуску пайплайна. Вы можете отредактировать и дополнить его в соответствии с особенностями вашего проекта.
