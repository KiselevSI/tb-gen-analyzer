# tb-gen-analyzer

Snakemake-пайплайн для анализа геномных данных микобактерий туберкулеза (MTB) с целью выявления генетических вариантов, связанных с лекарственной устойчивостью.

![Tuberculosis Resistance Analysis](https://img.shields.io/badge/TB-Resistance%20Analysis-blue)
![Python](https://img.shields.io/badge/Python-3.12-green)
![Snakemake](https://img.shields.io/badge/Snakemake-7.32-orange)

## Обзор

TB-Gen-Analyzer представляет собой комплексный пайплайн для биоинформатического анализа VCF-файлов, полученных при секвенировании геномов Mycobacterium tuberculosis. Пайплайн позволяет:

1. **Переименовывать хромосомы** в VCF-файлах для обеспечения совместимости с референсным геномом H37Rv
2. **Аннотировать варианты** с помощью snpEff для определения их функционального эффекта
3. **Анализировать устойчивость к противотуберкулезным препаратам** на основе обнаруженных мутаций
4. **Генерировать отчеты** о лекарственной устойчивости в формате CSV и подробные TXT-отчеты

## Структура репозитория

```
.
├── README.md                     # Документация проекта
├── Snakefile                     # Основной файл Snakemake с описанием этапов пайплайна
├── run_pipeline.py               # Скрипт для запуска пайплайна с заданными параметрами 
└── scripts/                      # Директория со скриптами и ресурсами
    ├── chr.txt                   # Файл сопоставления хромосом для переименования
    ├── tb_resistance.py          # Скрипт для анализа лекарственной устойчивости
    ├── tb_dr_detector.py         # Дополнительный скрипт для определения устойчивости
    └── db/                       # База данных и ресурсы
        ├── default_template.docx # Шаблон для отчетов
        ├── tbdb.barcode.bed      # Данные о линиях штаммов TB
        ├── tbdb.bed              # Сопоставление генов с препаратами
        ├── tbdb.dr.json          # База данных мутаций, связанных с устойчивостью
        ├── tbdb.fasta            # Референсная последовательность
        ├── tbdb.gff              # Аннотация генома
        ├── tbdb.mask.bed         # Маска для исключения регионов
        ├── tbdb.rules.yml        # Правила эпистаза для модификации предсказаний
        ├── tbdb.spoligotype_list.csv      # Список известных сполиготипов
        ├── tbdb.spoligotype_spacers.txt   # Данные о спейсерах для сполиготипирования
        └── tbdb.variables.json   # Конфигурация и метаданные БД
```

## Требования

- Python 3.12
- Micromamba (для управления окружениями)
- Snakemake
- bcftools
- snpEff
- Дополнительные Python-библиотеки: pyyaml

## Установка

Для установки и управления зависимостями используется micromamba, которая создает изолированное окружение в директории проекта.

```bash
# Установка micromamba (если еще не установлена)
# Инструкции: https://mamba.readthedocs.io/en/latest/micromamba-installation.html

# Создание окружения с зависимостями в текущей директории
micromamba create --prefix ./env -c conda-forge snakemake bcftools snpeff micromamba python=3.12
```

## Использование

### Подготовка входных данных

Входные данные должны быть в формате VCF.gz (сжатые VCF-файлы), которые содержат варианты генома MTB.

### Запуск пайплайна

Пайплайн можно запустить с помощью скрипта `run_pipeline.py`:

```bash
./run_pipeline.py -i path/to/vcf/*.vcf.gz -o results -t 4
```

#### Параметры:

- `-i, --input`: путь(и) к входным VCF-файлам (поддерживаются glob-выражения)
- `-o, --output`: директория для сохранения результатов
- `-t, --threads`: количество потоков для параллельного выполнения
- `-d, --detailed`: (опционально) генерировать подробные TXT-отчеты

### Рабочий процесс пайплайна

1. **Переименование хромосом**:
   - Инструмент: bcftools annotate
   - Входные данные: исходные VCF-файлы
   - Выходные данные: VCF с переименованными хромосомами (`results/vcf_renamed/`)

2. **Аннотация вариантов**:
   - Инструмент: snpEff
   - Входные данные: переименованные VCF-файлы
   - Выходные данные: аннотированные VCF-файлы (`results/annotated_vcfs/`)

3. **Анализ устойчивости**:
   - Инструмент: tb_resistance.py
   - Входные данные: аннотированные VCF-файлы
   - Выходные данные: отчеты в CSV и опционально TXT-форматах (`results/dr/`)

### Выходные данные

Для каждого образца пайплайн генерирует:

1. **CSV-отчет об устойчивости** (`<sample>.resistance.csv`) содержащий:
   - Список препаратов и статус устойчивости (R - устойчивый)
   - Мутации, ответственные за устойчивость
   - Тип устойчивости (Sensitive, RR-TB, HR-TB, MDR-TB, Pre-XDR-TB, XDR-TB)

2. **Подробный TXT-отчет** (`<sample>.resistance.detailed.txt`, опционально) с дополнительной информацией:
   - Детальная информация о вариантах
   - Дополнительные варианты вне известных маркеров устойчивости
   - Расширенная информация о потенциальных механизмах устойчивости

## Интерпретация результатов

TB-Gen-Analyzer классифицирует устойчивость согласно следующим категориям:

- **Sensitive**: Отсутствуют мутации, связанные с лекарственной устойчивостью
- **RR-TB**: Устойчивость только к рифампицину
- **HR-TB**: Устойчивость только к изониазиду
- **MDR-TB**: Множественная лекарственная устойчивость (как минимум к рифампицину и изониазиду)
- **Pre-XDR-TB**: MDR-TB с устойчивостью к фторхинолонам
- **XDR-TB**: Широкая лекарственная устойчивость (MDR-TB + устойчивость к фторхинолонам + устойчивость к препаратам группы A)

## Примечания и устранение неполадок

### Предупреждения snpEff

При аннотации могут появляться предупреждения, такие как `WARNING_TRANSCRIPT_NO_START_CODON`. Эти сообщения информативны и обусловлены особенностями аннотируемого генома. Они не останавливают выполнение пайплайна.

### Сообщения micromamba

При запуске через `micromamba run` могут появляться временные сообщения о блокировках (например, `Could not set lock (Resource temporarily unavailable)`). Эти предупреждения вызваны конкуренцией за общий кэш и не влияют на корректность выполнения пайплайна.

### Логи Snakemake

Логи выполнения хранятся в каталоге `.snakemake/log/`. Если обнаруживаются ошибки или отсутствуют ожидаемые выходные файлы, просмотрите логи для получения дополнительной информации.

## Разработка и вклад

Вы можете внести свой вклад в проект, отправив pull request или создав issue с предложениями улучшений или сообщениями об ошибках.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле [LICENSE](LICENSE).

---

*Обновлено: 09.04.2025*
